{% extends "user/base.html" %}

{% block content %}

<h2>Job: {{ job.id }}</h2>

<div class="container">
    <div class="card">
        <div><b>Status:</b> <span id="job-status">{{ job.status }}</span></div>
        <div id="job-error" style="display:none; margin-top:10px; color:#b00020;"></div>

        <div id="job-progress" style="margin-top:12px;">
        <div style="height:10px; background:#eee; border-radius:6px; overflow:hidden;">
            <div id="job-bar" style="width:0%; height:10px; background:#3b82f6;"></div>
        </div>
        <small id="job-hint" style="opacity:0.8;">Waiting for updates...</small>
        </div>
    </div>
</div>

<div class="container">
    <div id="job-result" style="margin-top:18px;">
        {% if job_result and job_result.images %}
        <h3>Result</h3>
        <div class="grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:12px;">
            {% for img in job_result.images %}
                {% set u = img.url %}
                {% if not u and img.filename %}
                    {% set u = "/user/jobs/" ~ job.id ~ "/image?filename=" ~ img.filename ~ "&subfolder=" ~ (img.subfolder or "") ~ "&type=" ~ (img.type or "output") %}
                {% endif %}
                <a href="{{ u }}" target="_blank" style="display:block;">
                    <img src="{{ u }}" alt="result" style="width:100%; border-radius:12px; border:1px solid #eee;" />
                </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<script>
    (function() {
        const jobId = "{{ job.id }}";
        const statusEl = document.getElementById("job-status");
        const errorEl = document.getElementById("job-error");
        const barEl = document.getElementById("job-bar");
        const hintEl = document.getElementById("job-hint");
        const resultEl = document.getElementById("job-result");

        let pct = 0;
        function tickBar() {
            pct = Math.min(95, pct + Math.random() * 7);
            barEl.style.width = pct.toFixed(0) + "%";
        }

        function imgUrl(img) {
        if (img && img.url) return img.url;

        // fallback: filename/subfolder/type -> proxy route
        if (img && img.filename) {
            const filename = encodeURIComponent(img.filename);
            const subfolder = encodeURIComponent(img.subfolder || "");
            const type = encodeURIComponent(img.type || "output");
            return `/user/jobs/${jobId}/image?filename=${filename}&subfolder=${subfolder}&type=${type}`;
        }
        return null;
        }

        function renderResult(result) {
        if (!result || !result.images || !result.images.length) return;

        const items = result.images.map(img => {
            const url = imgUrl(img);
            if (!url) return "";
            return `
            <a href="${url}" target="_blank" style="display:block;">
                <img src="${url}" alt="result" style="width:100%; border-radius:12px; border:1px solid #eee;" />
            </a>
            `;
        }).join("");

        if (!items.trim()) return;

        resultEl.innerHTML = `
            <h3>Result</h3>
            <div class="grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:12px;">
            ${items}
            </div>
        `;
        }

        async function poll() {
        try {
            const res = await fetch(`/user/jobs/${jobId}/state`, { credentials: "include" });
            if (!res.ok) throw new Error("Failed to fetch job state");
            const data = await res.json();

            // console.log(data.result);

            statusEl.textContent = data.status;

            if (data.status === "ERROR") {
                errorEl.style.display = "block";
                errorEl.textContent = data.error || "Unknown error";
                hintEl.textContent = "Job failed";
                barEl.style.width = "100%";
                barEl.style.background = "#b00020";
                return;
            }

            if (data.status === "DONE") {
                hintEl.textContent = "Done";
                barEl.style.width = "100%";
                barEl.style.background = "#16a34a";
                renderResult(data.result);
                return;
            }

            if (data.progress && typeof data.progress.percent === "number") {
                const p = Math.max(0, Math.min(100, data.progress.percent));
                barEl.style.width = p.toFixed(0) + "%";
                hintEl.textContent = (data.status === "QUEUED") ? "Queued..." : `Running... ${p.toFixed(0)}%`;
            } else {
                tickBar();
                hintEl.textContent = (data.status === "QUEUED") ? "Queued..." : "Running...";
            }
            setTimeout(poll, 1500);
        } catch (e) {
            setTimeout(poll, 2500);
        }
        }

        poll();
    })();
</script>

{% endblock %}